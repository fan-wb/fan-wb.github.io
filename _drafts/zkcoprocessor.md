---

title: ZK 协处理器

date: 2024-07-22 12:00:00 +0800

categories: [Blockchain]

tags: [zk]

pin: false

math: true


---

## 协处理器背景及概念

在传统计算机架构中，协处理器是一种专用的计算机处理单元，旨在协助中央处理器 (CPU) 执行特定类型的计算任务。与通用的 CPU 相比，协处理器通常针对某些特定场景进行了优化，如深度学习、图形渲染、加密解密、信号处理等，能够显著提高这些任务的处理速度和效率。NVIDIA 提出的图形处理器 (GPU) 是协处理器的经典例子，它专为图形渲染和并行计算而设计，极大地提升了计算机处理图像、视频和复杂计算任务的能力。CPU 虽能执行多数任务，但在模型训练或运行大型游戏等特定高算力需求场景中，GPU 作为协处理器的辅助不可或缺。协处理器架构的核心在于**通过功能解耦和异步协同来提升复杂系统的计算效率和资源利用率**。将此模式类比至区块链领域，以太坊链本身就相当于 CPU，而 ZK 协处理器则类似 GPU。

当前阻碍以太坊链上应用发展的主要瓶颈可归纳为：

- 链上计算成本高昂。由于每项操作均需计量 Gas，复杂应用逻辑的执行成本会迅速攀升至令人难以接受的程度。

- 数据流通不畅。在 EVM 中，智能合约只能访问最近 256 个区块头的数据。除了虚拟机状态中存储的数据、最新区块数据和其他公开智能合约的数据外，合约若要无信任地利用 DA 层存档节点访问特定区块中的历史数据可能需要耗费大量资源。另外，2025 年的 Pectra 升级还可能引入 EIP-4444，届时全节点将不再存储一年以前的历史数据，这将进一步导致数据的缺失。

问题的根本在于 EVM 的设计重点是在保证安全性和去中心化的前提下执行智能合约代码，其本身并不适合处理复杂计算和数据密集型任务。因此，当涉及需要大量计算资源的任务时，就需要寻求其他解决方案。在此背景下，ZK 协处理器应运而生，通过 ZK 技术保证链下计算和数据使用的无信任性，为解决这一问题提供了新的可能性。但当前业界对于 ZK 协处理器的定义仍未达成一致，对应以上两点，项目方和社区中也逐渐衍生出了两种对 ZK 协处理器的功能偏好：

- 计算卸载 ZK 协处理器：主要功能是将复杂计算转移到链下 zkVM，并将结果反馈至链上，将 $O(n)$ 的计算压缩为 $O(1)$ 的验证。
- 数据访问 ZK 协处理器：类似状态预言机，主要功能是访问历史数据并将其无信任地馈送到特定位置（如智能合约）。

<img src="https://fanwb.oss-cn-beijing.aliyuncs.com/img/sevenxventures.eth__JMWKYVob9x3COlO7V2k71pN_pZORc4DVcByhfU0ZaQ.png" style="zoom: 67%;" />
_图1 ZK 协处理器分类 | 图源：SevenX Ventures_

不同项目使用的术语有所不同，但其核心理念是一致的：ZK 协处理器利用零知识证明技术令链上数据访问和链下计算的无信任委托成为可能。由此，开发者得以将高成本操作转移至 ZK 协处理器上执行，仅需在链上直接使用结果即可。应用可在有效控制 Gas 成本的同时扩大规模、访问更多数据，实现降本增效。这类方案本质上是将数据访问及计算与区块链共识解耦，在不损害去中心化和安全性的前提下，显著提升了智能合约的可扩展性和效率，并为链上应用引入了新的设计范式。

> ZK Rollup 在 L1 网络上大规模支持同类型计算，一定意义上也可被视为最早的 ZK 协处理器。关键区别在于 ZK Rollup 作用在区块链协议层面，而现今所讨论的 ZK 协处理器则聚焦于去中心化应用层面。
{: .prompt-info }

## ZK 协处理器技术架构

目前协处理器的主要应用场景可分为链上数据索引 ZK-Query、预言机 ZK-Oracle、零知识机器学习 ZKML 以及囊括多种用途的通用零知识虚拟机 ZKVM 等。本文将以主要的通用 ZK 协处理器为例，对其技术架构进行介绍和分析。

### Lagrange

Lagrange 的愿景用一句话概括：通过在大数据规模上实现对区块链数据的可验证计算，释放新型数据密集型和跨链应用的潜力。从技术层面来说，就是创建一个包含原始区块链数据子集的可证明数据库，并对其实现高效查询。要达成这一目标，主要涉及两个关键步骤：

1. 预处理或索引：对每个区块的合约存储进行索引，并将数据预处理成 SNARK 优化的数据结构，以可证明的方式插入支持可证明查询的可验证数据库中。由于大多数区块链的数据结构是非“证明友好”的，因此该步骤是计算密集度最高的环节。

2. 执行可证明查询：当智能合约请求时，在可验证数据库上并行运行可证明查询。预处理完成后，证明器网络能以低成本为用户在 ZK 友好的数据上证明大规模 SQL 查询由于协处理器天然可并行化，证明过程可通过并行计算和并行证明生成在任意数量的操作者之间实现横向扩展。最终生成的证明可在链上验证，赋予开发者直接从智能合约高效查询链上数据的能力。

<img src="https://fanwb.oss-cn-beijing.aliyuncs.com/img/666244df77a7e65f0c48e615_ZK Coprocessor Diagram.svg" style="zoom:85%;" />
_图2 Lagrange ZK 协处理器说明 | 图源：Lagrange_

Lagrange 网络的两个核心功能与上述两步相对应：

1. **可验证数据库**：本质上就是用支持高效分布式查询的格式重新构建目标区块链的数据库（包括存储、状态和区块）。

2. **ZKMR**：使用增加了可验证性的分布式 MapReduce 架构，将计算横向扩展到多台机器上，每台机器仅负责处理大规模数据集上的一小块数据，最后依靠归约操作聚合得到单一结果。

#### **可验证数据库**

<img src="https://fanwb.oss-cn-beijing.aliyuncs.com/img/verifiable-db-architecture.png" style="zoom:45%;" />
_图3 Lagrange 数据库说明  | 图源：Lagrange Docs_

ZK 协处理器会为每个区块的原始存储树生成支持高效查询的等效版本。在上图中，可生成证明确保新数据库中包含与原始红色区块链数据结构相同的数据。

可验证数据库分为三类：

- 存储数据库：包含从合约存储树中索引的叶子节点子集。每个合约对应一个这样的数据库。

- 状态数据库：包含状态树中引用合约的叶子节点子集。状态数据库的每个叶子/条目都与相应的存储数据库相关联。

- 区块数据库：将状态数据库链接到链上的特定区块，包含 ZK 协处理器先前处理的所有区块的状态数据库。

**存储数据库**

存储数据库的数据结构与原始合约存储树是可证明等效的，主要区别在于两者使用了不同的编码函数、哈希函数及树结构，新数据库对“ZK查询”更加友好。

![](https://fanwb.oss-cn-beijing.aliyuncs.com/img/lagrange.drawio.png)
_图4 Lagrange 存储数据库的构建_

存储数据库仅包含合约存储 MPT 的一个子集，协处理器从存储 MPT 中提取需要的目标键值对，通过递归证明重新构建 ZK 友好的 Merkle 树，并用基于多集哈希的子集累加器来证明新 Merkle 树和原始存储 MPT 的等价性。存储数据库用于 ZK 协处理器的后续查询。

**状态数据库**

该结构的作用是将不同合约的存储数据库整合为一个统一的状态数据库。叶子节点中包含了 ZK 协处理器正在索引的智能合约的信息（合约的地址及相应存储数据库的根哈希）。

<img src="https://fanwb.oss-cn-beijing.aliyuncs.com/img/0_Q8JPkLsYNlkuWl9K.webp" style="zoom:45%;" />
_图5 Lagrange 状态数据库说明 | 图源：Lagrange Docs_

当查询或验证某个合约的状态时，只需找到该合约在状态数据库中的叶子节点，就可以获取其存储数据库的根哈希值。这使得跨合约的查询和验证变得更加高效和灵活。

**区块数据库**

ZK 协处理器需要保留每个区块的状态和存储树，本质上是在每个区块上对数据库进行快照。保证快照间状态转换的正确性是至关重要的，即需要证明最新插入的状态确实属于目标区块链中的对应区块，且新块是紧接在前一个块之后的。Lagrange 采用的方法是用一种更适合证明的数据结构重新创建连续的区块结构，如下图所示，该结构会在每个新块生成时更新。

<img src="https://fanwb.oss-cn-beijing.aliyuncs.com/img/block-db.png" style="zoom: 33%;" />
_图6 Lagrange 区块数据库说明 | 图源：Lagrange Docs_

树的叶子节点是 SNARK 友好的区块头 (SFBH, SNARK-friendly block header)。区块头中包含以下信息：
- 区块编号
- 原始区块链中的区块哈希
- 与此区块编号对应的状态根

树的大小被设定为固定值，叶子节点数为 $2^{26}$ ，出块时间为 12 秒时，该数据库约可使用 25 年。每次更新该树都会生成一个递归证明 $p$，表明树已从原始根 $U_0$ 正确更新到当前区块编号 $U_i$，即等价数据库包含与原始区块链相同的数据。

#### ZK MapReduce

Lagrange 的 ZK MapReduce (ZKMR) 扩展了 MapReduce，利用递归证明来验证大量链上状态数据的分布式计算的正确性。在分布式计算任务的 Map 或 Reduce 步骤中，ZKMR 为每个工作节点生成计算正确性的证明，并将其递归组合，构建整个分布式计算工作流的单个有效性证明。由此 ZKMR 能够高效应用于大型数据集上的复杂计算，其性能是随并行机器的数量横向扩展的，而传统顺序执行则随时间纵向扩展。在最大并行化运行时，证明该 MapReduce 过程的时间复杂度为 $O(log(n))$，而顺序执行的运行时间为 $O(n)$。

效率是分布式计算主导 Web2 大数据处理的主要原因，而在零知识语境下，其分布式计算的可扩展性和容错性则使其成为了无信任大数据应用（如链上定价、波动性和流动性分析）的理想基础架构。

<img src="https://fanwb.oss-cn-beijing.aliyuncs.com/img/665e891695b30f8062451985_AD_4nXe3pqIUpEUNQU79x5--Z7i-QJkRqu8HSE_nKbSBp2YbttEsKBvW1nCZirN9o--yaHydRhfH8OHGeOVPNPY4_S3FTYyhTjeUdWphSytU6o6Wq6RB8AQ8mL0AAbzVOJVHF-lXSIo4rJwpCjh765FTI87NsUo.png" style="zoom:50%;" />
_图7 Lagrange 执行流程 | 图源：Lagrange_

其执行流程如上图所示：

1. 开发者首先在 Lagrange 上注册合约，随后向 Lagrange 的链上代理合约提交请求，如对历史数据的 SQL 查询。
2. 链下的 Lagrange 网络通过将调度器将请求分解为可并行执行的任务并分发给证明器网络，由其异步计算结果。
3. 证明器随后会将计算结果及其证明提交回链上合约，使开发者能够验证结果的正确性。验证完成即可直接在应用逻辑中使用计算结果，大量节省 Gas 成本。
4. 证明器网络的安全性由 EigenLayer 的 Restaking 技术保障。

### RISC Zero

RISC Zero 的核心技术包括基于 RISC-V 指令集架构的通用 ZKVM，以及在此基础上构建的 ZK 协处理器 Bonsai。

#### RISC Zero ZKVM

RISC Zero ZKVM 可以证明任意代码的正确执行，使开发者能够使用 Rust 和 C++ 等成熟语言构建 ZK 应用程序，无需自行构建电路或使用自定义语言编写代码。

<img src="https://fanwb.oss-cn-beijing.aliyuncs.com/img/security-model-diagram-70478725ab3b760ff9bf29eee53a4f74.svg" style="zoom:80%;" />
_图8 RISC Zero ZKVM 架构 | 图源：RISC Zero Developer Docs_

开发者构建 ZK 应用时，只需将 Rust 源代码编译成的 ELF 二进制文件及程序运行依赖的输入提交至 ZKVM，即可得到包含计算结果及其证明的 Receipt。Receipt 可自由分享给第三方，并可使用验证器合约在链上进行验证。如下图所示，程序运行结果的证明是由执行器将应用代码的执行轨迹分片交由证明器经过多次递归证明得到的。

<img src="https://fanwb.oss-cn-beijing.aliyuncs.com/img/1725358950812.png" style="zoom:80%;" />
_图9 RISC Zero ZKVM 证明生成 | 图源：Youtube_

RISC Zero 中的证明器是完全开源的，开发者可选择使用本地硬件运行 ZKVM 自行生成证明，也可使用 RISC Zero 提供的远程证明服务 Bonsai。

#### Bonsai

Bonsai 是独立的零知识证明网络，任意链、协议和应用都可调用该网络进行链下计算，并将生成的零知识证明发布上链进行验证，因此 Bonsai 可被视为与链无关的通用 ZK 协处理器。Bonsai 具备高性能和高并行行，证明请求会由动态的 GPU 集群快速完成。

其主要功能包括：Bonsai 结合了三个关键要素,打造出一个独特的网络,将使区块链生态系统中能够开发出新类型的应用:

- 能在零知识/可验证的环境下运行任意虚拟机的通用 ZKVM
- 可直接集成到任意智能合约或链中的证明系统
- 可将 Bonsai 证明的计算分发到各个链上的通用 Rollup

<img src="https://fanwb.oss-cn-beijing.aliyuncs.com/img/cd81185b-2f6b-4b27-8449-e7989c80638a_1600x755.png" style="zoom: 35%;" />
_图10 ZK 协处理器 Bonsai | 图源：RISC Zero Developer Docs_

Bonsai 的核心组件包括：

- 证明器网络：即运行 ZKVM 证明器的节点网络，负责执行并证明由 Bonsai API 发来的请求。未来该网络将逐渐转向去中心化，允许无需可参与。

- 请求池：存储证明请求及其元数据的数据库。该池还将作为定序器，为节点构建区块。许多证明将被拆分以提高证明效率。

- Rollup 引擎：将证明器网络生成的证明汇总成单一的根证明，发布到链上供验证者验证其有效性。
- Image Hub：允许开发者存储可由智能合约执行的函数和程序映像，映像的执行可通过 Bonsai 和 ZKVM 进行零知识证明。Image Hub 能为开发者提供了强大的编程原语，使 Bonsai 可以充当任意链之间的共享执行层，并大幅增加智能合约的功能。
- 状态存储：Bonsai 还将引入链下状态存储，变量以键值对的形式存储在 Bonsai 上，以便 Bonsai 中的函数和程序映像访问。
- 证明市场：未来 Bonsai 将以去中心化的形式运行，参与者可以在其中提供证明服务。证明市场将匹配证明需求方和算力供给方，确保有效地满足证明请求，优化网络内的资源分配，提高 Bonsai 的整体效率和可靠性。

### Succinct

Succinct 将自身定位为“可编程事实” (Programmable Truth) 协议，旨在构建 ZK 基础设施层，推动可编程事实在区块链开发栈中的集成。

其核心组件是基于 RISC-V 指令集架构的 ZKVM——Succinct Processor 1 (SP1)。





Succinct可以接受包括Solidity和零知识领域的专门语言（DSL）等代码，传入到链下的Succinct协处理器，Succinct完成目标链的数据索引，然后将证明申请发送给证明市场，能够支持CPU、GPU以及ETC等芯片的矿机在证明网络中提交证明。其特点在于证明市场对于各种证明系统都兼容，因为未来会有很长一段各种证明系统并存的时期。

Succinct的链下ZKVM称为SP（Succinct Processor），其能够支持Rust语言以及其它的LLVM语言，其核心特性包括：

1. 递归+验证：基于STARKs技术的递归证明技术，能够指数级增强ZK压缩效率。
2. 支持SNARKs到STARKs包装器：能够同时采纳SNARKs和STARKs优点，解决证明大小和验证时间的权衡问题。
3. 预编译为中心的 zkVM 架构：对于一些常见的算法如SHA256、Keccak、ECDSA等，能够提前编译以减少运行时的证明生成时间和验证时间。







### ZKM

### Valita



